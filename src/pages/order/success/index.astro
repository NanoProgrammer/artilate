---
import '../../../styles/global.css'
import Header from '../../../components/Header.astro'
import Footer from '../../../components/Footer.astro'

// Order ID
const sp = Astro.url.searchParams
const orderId =
  sp.get('order') ?? sp.get('orderId') ?? sp.get('oid') ?? '—'

const title = 'Order Confirmed — Artilate Handcrafted Chocolates'
const description = `Thank you! Your order ${
  orderId !== '—' ? '#' + orderId : ''
} was received. We’re preparing your handcrafted chocolates in Alberta.`
---

<html lang="en-CA" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content="noindex, nofollow" />

    <!-- Canonical -->
    <link rel="canonical" href={Astro.url.toString()} />

    <!-- OG -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="/assets/og.png" />

    <!-- Favicon -->
    <link rel="icon" href="/assets/logo-completo.png" />




    <!-- Fonts -->
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/Inter-VariableFont_opsz,wght.woff2"
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/PlayfairDisplay-VariableFont_wght.woff2"
      crossorigin
    />

    <!-- FULL STYLE (copiado del layout original) -->
    <style>
      :root {
        --cacao:#0A0B0D;
        --ivory:#FAFAF9;
        --gold:#D4A373;
        --amber:#F59E0B;
        --warm-gray:rgba(250,250,249,.8);
      }
      body { 
        background: var(--cacao); 
        color: var(--ivory); 
        line-height:1.6; 
        margin:0;
        overflow-x:hidden;
      }
      .container {
        max-width:1280px; 
        margin:0 auto; 
        padding:0 2rem;
      }

      /* -------- SUCCESS PAGE STYLES -------- */

      .error-page {
        min-height: calc(90vh);
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
        text-align:center;
        padding-bottom:32px;
        background:
          radial-gradient(ellipse at 30% 20%, rgba(91,33,182,.08) 0%, transparent 50%),
          radial-gradient(ellipse at 70% 80%, rgba(245,158,11,.06) 0%, transparent 50%);
      }

      .error-content { 
        position:relative; 
        z-index:2; 
        max-width:800px;
        margin:0 auto;
      }

      .chocolate-crack {
        margin-bottom:1rem;
        opacity:0;
        animation:crackAppear 1s ease-out .5s forwards;
      }

      .crack-svg{ width:100%; max-width:600px; height:120px; }
      .crack-line{
        stroke-dasharray:1000;
        stroke-dashoffset:1000;
        animation:drawCrack 2s ease-out .8s forwards;
      }

      @keyframes crackAppear { to { opacity:1 } }
      @keyframes drawCrack { to { stroke-dashoffset:0 } }

      h1 {
        font-family:'Playfair Display', serif;
        font-size:clamp(2rem,5vw,3.5rem);
        font-weight:600;
        margin-bottom:1rem;
        text-shadow:0 4px 20px rgba(212,163,115,.3);
        opacity:0;
        transform:translateY(20px);
        animation:slideUp .8s ease-out 1.2s forwards;
      }

      p {
        font-size:1.125rem;
        color:var(--warm-gray);
        max-width:560px;
        margin:0 auto 2.25rem;
        line-height:1.7;
        opacity:0;
        transform:translateY(20px);
        animation:slideUp .8s ease-out 1.5s forwards;
      }

      @keyframes slideUp { to { opacity:1; transform:translateY(0) } }

      .primary-btn{
        background:linear-gradient(135deg, var(--gold), var(--amber));
        padding:14px 28px;
        border-radius:12px;
        color:#000;
        text-decoration:none;
        font-weight:600;
        display:inline-flex;
        align-items:center;
        gap:10px;
        transition:all .3s ease;
      }

      .primary-btn:hover{
        transform:translateY(-2px);
        box-shadow:0 8px 24px rgba(212,163,115,.4);
      }

      .quick-links a{
        color:rgba(212,163,115,.85);
        text-decoration:none;
        font-weight:500;
        margin:0 .75rem;
      }
    </style>
  </head>

  <body>
    <script>
  // gtag SIEMPRE existe (aunque GA no haya cargado)
  window.dataLayer = window.dataLayer || [];
  window.gtag = function(){ dataLayer.push(arguments); };

  // bandera para saber cuándo GA4 terminó de cargar
  window.__gtag_loaded = false;
</script>

<!-- Carga GA4 Y ADS -->
<script async 
  src="https://www.googletagmanager.com/gtag/js?id=G-Y8Q1XJ8KRW"
  onload="window.__gtag_loaded = true">
</script>

<script>
  gtag('js', new Date());
  gtag('config', 'G-Y8Q1XJ8KRW');
  gtag('config', 'AW-17710658719');
</script>

    <Header />

    <main class="error-page">
      <div class="container error-content">

        <!-- CRACK -->
        <div class="chocolate-crack">
          <svg viewBox="0 0 800 200" class="crack-svg" aria-hidden="true">
            <path class="crack-line" 
                  d="M50,100 Q200,80 300,100 T500,120 Q600,110 750,100"
                  stroke="url(#crackGradient)" stroke-width="3" fill="none"/>
            <defs>
              <linearGradient id="crackGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#D4A373;stop-opacity:0" />
                <stop offset="50%" style="stop-color:#F59E0B;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#D4A373;stop-opacity:0" />
              </linearGradient>
            </defs>
          </svg>
        </div>

        <h1>Thank you for your order!</h1>

        <p>
          {orderId !== '—' ? `Order #${orderId} confirmed.` : 'Your order has been confirmed.'}
          We’ve emailed your receipt and next steps.
        </p>

        <a href="/shop" class="primary-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <path d="M16 10a4 4 0 0 1-8 0" />
          </svg>
          Continue Shopping
        </a>

        <div style="margin-top:2.5rem;">
          <h3>Explore more:</h3>
          <div class="quick-links">
            <a href="/about">Our Story</a>
            <a href="/faq">FAQ</a>
            <a href="/contact">Contact</a>
          </div>
        </div>

      </div>
    </main>


<script>
(async () => {
  try {
    if (window.__artilateConversionSent) return;
    window.__artilateConversionSent = true;

    // Esperar hasta que GA haya cargado por completo
    while (!window.__gtag_loaded) {
      await new Promise(r => setTimeout(r, 30));
    }

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");
    if (!sessionId) return;

    const res = await fetch(`/api/checkout?session_id=${sessionId}`);
    if (!res.ok) return;

    const data = await res.json();
    if (!data?.amount_total || !data.currency || !data.id) return;

    const amount = data.amount_total / 100;
    const currency = data.currency.toUpperCase();

    // GA4 purchase
    gtag('event', 'purchase', {
      transaction_id: data.id,
      value: amount,
      currency,
      items: [{
        item_id: "artilate_order",
        item_name: "Artilate Order",
        quantity: 1,
        price: amount
      }]
    });

    // Google Ads conversion
    gtag('event', 'conversion', {
      send_to: 'AW-17710658719/wq67CJeHgskbEJ_pjP1B',
      value: amount,
      currency,
      transaction_id: data.id
    });

  } catch (err) {
    console.error("conversion tracking error", err);
  }
})();
</script>

    <Footer />
  </body>
</html>
