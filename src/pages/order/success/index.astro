---
import '../../../styles/global.css'
import Header from '../../../components/Header.astro'
import Footer from '../../../components/Footer.astro'

// Order ID
const sp = Astro.url.searchParams
const orderId =
  sp.get('order') ?? sp.get('orderId') ?? sp.get('oid') ?? 'â€”'

const title = 'Order Confirmed â€” Artilate Handcrafted Chocolates'
const description = `Thank you! Your order ${
  orderId !== 'â€”' ? '#' + orderId : ''
} was received. Weâ€™re preparing your handcrafted chocolates in Alberta.`
---
<html lang="en-CA" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content="noindex, nofollow" />

    <!-- Canonical -->
    <link rel="canonical" href={Astro.url.toString()} />

    <!-- OG -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="/assets/og.png" />

    <!-- Favicon -->
    <link rel="icon" href="/assets/logo-completo.png" />

    <!-- Fonts -->
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/Inter-VariableFont_opsz,wght.woff2"
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/PlayfairDisplay-VariableFont_wght.woff2"
      crossorigin
    />

    <!-- Full page styles (unchanged) -->
    <style>
      :root {
        --cacao:#0A0B0D;
        --ivory:#FAFAF9;
        --gold:#D4A373;
        --amber:#F59E0B;
        --warm-gray:rgba(250,250,249,.8);
      }
      body { 
        background: var(--cacao); 
        color: var(--ivory); 
        line-height:1.6; 
        margin:0;
      }
      .container { max-width:1280px;margin:0 auto;padding:0 2rem; }
      .error-page {
        min-height:90vh;display:flex;align-items:center;justify-content:center;
        text-align:center;padding-bottom:32px;
      }
      h1 { font-size:clamp(2rem,5vw,3.5rem); }
    </style>
  </head>

  <body>

    <!-- ðŸ”¥ GTAG SIEMPRE EXISTE -->
    <script>
      window.dataLayer = window.dataLayer || [];
      window.gtag = function(){ dataLayer.push(arguments); };
      window.__gtag_loaded = false;
    </script>

    <!-- ðŸ”¥ Carga GA4 + Ads -->
    <script async 
      src="https://www.googletagmanager.com/gtag/js?id=G-Y8Q1XJ8KRW"
      onload="window.__gtag_loaded = true">
    </script>

    <!-- ðŸ”¥ Config GA4 y Ads SIEMPRE DESPUÃ‰S DE CREAR gtag -->
    <script>
      gtag('js', new Date());
      gtag('config', 'G-Y8Q1XJ8KRW');
      gtag('config', 'AW-17710658719');
    </script>

    <Header />

    <main class="error-page">
      <div class="container">
        <h1>Thank you for your order!</h1>

        <p>
          {orderId !== 'â€”' ? `Order #${orderId} confirmed.` : 'Your order has been confirmed.'}
          Weâ€™ve emailed your receipt and next steps.
        </p>

        <a href="/shop" class="primary-btn">Continue Shopping</a>

        <div style="margin-top:2rem;">
          <a href="/about">Our Story</a> â€¢
          <a href="/faq">FAQ</a> â€¢
          <a href="/contact">Contact</a>
        </div>
      </div>
    </main>

    <!-- ðŸ”¥ Conversion tracking, imposible que falle -->
    <script>
      (async () => {
        try {
          if (window.__artilateConversionSent) return;
          window.__artilateConversionSent = true;

          // Esperar GA cargado
          while (!window.__gtag_loaded) {
            await new Promise(r => setTimeout(r, 25));
          }

          const params = new URLSearchParams(window.location.search);
          const sessionId = params.get("session_id");
          if (!sessionId) return;

          const res = await fetch(`/api/checkout?session_id=${sessionId}`);
          if (!res.ok) return;

          const data = await res.json();
          if (!data?.amount_total || !data.id || !data.currency) return;

          const amount = data.amount_total / 100;
          const currency = data.currency.toUpperCase();

          // GA4 purchase
          gtag('event', 'purchase', {
            transaction_id: data.id,
            value: amount,
            currency,
            items: [{
              item_id: "artilate_order",
              item_name: "Artilate Order",
              quantity: 1,
              price: amount
            }]
          });

          // Google Ads conversion
          gtag('event', 'conversion', {
            send_to: 'AW-17710658719/wq67CJeHgskbEJ_pjP1B',
            value: amount,
            currency,
            transaction_id: data.id
          });
        } catch (e) {
          console.error("conversion tracking error", e);
        }
      })();
    </script>

    <Footer />
  </body>
</html>
