---
import '../styles/global.css'
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'

type HreflangLink = { hreflang: string; href: string }
type PreloadImage = {
  href: string
  as?: 'image'
  fetchpriority?: 'high' | 'low'
  imagesrcset?: string
  imagesizes?: string
}
interface Crumb { href: string; name: string }

export interface Props {
  children?: any
  title?: string
  description?: string
  image?: string
  locale?: string
  alternates?: string[]
  alternatesLinks?: HreflangLink[]
  xDefault?: string
  noindex?: boolean
  nocache?: boolean
  ogType?: 'website' | 'article' | 'product'
  author?: string
  publishDate?: string
  modifiedDate?: string
  breadcrumbs?: Crumb[]
  prevUrl?: string
  nextUrl?: string

  // â¬‡ relajamos el tipo para no pelear con TS
  preloadImages?: any[]

  // â¬‡ igual aquÃ­, tu objeto JSON-LD entra sin problemas
  schemaExtras?: any

  canonical?: string
}

const {
  title = 'Artilate â€” Handcrafted Chocolates in Alberta',
  description = 'Premium bean-to-bar chocolates and filled bonbons made in Alberta. Ethically sourced cacao, handcrafted flavours, local delivery & events.',
  image = '/assets/og.png',
  locale = 'en-CA',
  alternates = ['fr-CA'],
  alternatesLinks = [] as HreflangLink[],
  xDefault = 'en-CA',
  noindex = false,
  nocache = false,
  ogType = 'website',
  author = 'Artilate',
  publishDate,
  modifiedDate,
  breadcrumbs = [] as Crumb[],
  prevUrl = '',
  nextUrl = '',
  preloadImages = [] as PreloadImage[],
  schemaExtras = {},
  canonical: canonicalProp,
} = Astro.props as Props

const canonical =
  canonicalProp ??
  (Astro.site
    ? new URL(Astro.url.pathname + Astro.url.search, Astro.site).toString()
    : Astro.url.toString())

const robots = noindex ? 'noindex, nofollow' : 'index, follow'
const googlebot = noindex
  ? 'noindex, nofollow, nosnippet'
  : 'index, follow, max-snippet:-1, max-image-preview:large'
const pragmaCache = nocache ? 'no-cache' : undefined

const resolvedAlternates: HreflangLink[] =
  alternatesLinks.length > 0
    ? alternatesLinks
    : alternates.map((h) => ({ hreflang: h, href: canonical }))

const breadcrumbLd =
  (breadcrumbs?.length ?? 0) > 0
    ? {
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: breadcrumbs.map((c: Crumb, i: number) => ({
          '@type': 'ListItem',
          position: i + 1,
          name: c.name,
          item: c.href,
        })),
      }
    : null

const SITE = {
  name: 'Artilate',
  legalName: 'Artilate Chocolates Ltd.',
  slogan: 'Artilate consciously made',
  phone: '+1-587-700-3560',
  email: 'admin@artilate.com',
  logo: '/logo-completo.png',
  sameAs: [
    'https://www.instagram.com/artilate',
    'https://www.facebook.com/artilate',
    'https://www.tiktok.com/@artilate',
  ],
  address: {
    streetAddress: 'â€”',
    addressLocality: 'Airdrie',
    addressRegion: 'AB',
    postalCode: 'T4B',
    addressCountry: 'CA',
  },
  geo: { latitude: 51.2927, longitude: -114.0134 },
  serviceArea: ['Calgary', 'Airdrie', 'Edmonton', 'Okotoks', 'Cochrane', 'Rocky View County'],
  hours: 'Mo-Fr 10:00-18:00',
  currency: 'CAD',
} as const

const localBusinessLd = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': canonical + '#business',
  name: SITE.name,
  legalName: SITE.legalName,
  description,
  url: canonical,
  image,
  telephone: SITE.phone,
  email: SITE.email,
  logo: SITE.logo,
  slogan: SITE.slogan,
  priceRange: '$$',
  address: { '@type': 'PostalAddress', ...SITE.address },
  geo: { '@type': 'GeoCoordinates', ...SITE.geo },
  areaServed: SITE.serviceArea.map((a) => ({ '@type': 'AdministrativeArea', name: a })),
  sameAs: SITE.sameAs,
  openingHours: [SITE.hours],
  hasOfferCatalog: {
    '@type': 'OfferCatalog',
    name: 'Chocolates & Bonbons',
    itemListElement: [
      { '@type': 'Offer', itemOffered: { '@type': 'Product', name: 'Filled Bonbons' } },
      { '@type': 'Offer', itemOffered: { '@type': 'Product', name: 'Bean-to-Bar Bars' } },
      { '@type': 'Offer', itemOffered: { '@type': 'Product', name: 'Seasonal Boxes' } },
    ],
  },
  ...schemaExtras,
}

const webSiteLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  url: canonical,
  name: SITE.name,
  publisher: { '@type': 'Organization', name: SITE.legalName, logo: SITE.logo },
  potentialAction: {
    '@type': 'SearchAction',
    target: canonical.replace(/\/$/, '') + '/search?q={search_term_string}',
    'query-input': 'required name=search_term_string',
  },
}

// ðŸš« Modo sin tracking para Lighthouse: ?notrack=1
const noTracking = Astro.url.searchParams.get('notrack') === '1'
---

<html lang={locale} class="scroll-smooth">
  <head>
     <slot name="head" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content={robots} />
    <meta name="googlebot" content={googlebot} />
    {pragmaCache && <meta http-equiv="Cache-Control" content={pragmaCache} />}

    <!-- Canonical & hreflang -->
    <link rel="canonical" href={canonical} />
    <link rel="alternate" hreflang={xDefault} href={canonical} />
    {resolvedAlternates.map((alt) => (
      <link rel="alternate" hreflang={alt.hreflang} href={alt.href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={canonical} />

    <!-- Open Graph / Twitter -->
    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content={SITE.name} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={image} />
    <meta property="og:locale" content={locale} />
    {resolvedAlternates.map((alt) => (
      <meta property="og:locale:alternate" content={alt.hreflang} />
    ))}
    {publishDate && <meta property="article:published_time" content={publishDate} />}
    {modifiedDate && <meta property="article:modified_time" content={modifiedDate} />}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />
    <meta name="author" content={author} />

    <!-- Pagination (SEO) -->
    {prevUrl && <link rel="prev" href={prevUrl} />}
    {nextUrl && <link rel="next" href={nextUrl} />}

    <!-- Preconnects solo necesarios (no Google Fonts) -->
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8Q1XJ8KRW">
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8Q1XJ8KRW');
  gtag('config', 'AW-17710658719');
</script>
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>

    <!-- ðŸ”¤ Preload de fuentes locales (Inter + Playfair) -->
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/Inter-VariableFont_opsz,wght.woff2"
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/font/PlayfairDisplay-VariableFont_wght.woff2"
      crossorigin
    />

    <!-- Preload de imÃ¡genes crÃ­ticas (LCP) configurable por pÃ¡gina -->
    {preloadImages.map((i) => (
      <link
        rel="preload"
        as={i.as ?? 'image'}
        href={i.href}
        fetchpriority={i.fetchpriority ?? 'high'}
        imagesrcset={i.imagesrcset}
        imagesizes={i.imagesizes}
      />
    ))}

    <!-- CSS crÃ­tico mÃ­nimo (Hero) -->
    <style>
      :root{--cacao:#0A0B0D;--ivory:#FAFAF9;--gold:#D4A373;--amber:#F59E0B}
      .hero{position:relative;display:flex;align-items:center;background:var(--cacao);color:var(--ivory);overflow:hidden}
      .container{max-width:1280px;margin:0 auto;padding:0 1rem;position:relative;z-index:2;width:100%}
      .hero-title{font-family:'Playfair Display',serif;font-weight:700;line-height:1.1}
      .primary-btn,.secondary-btn{border-radius:12px;padding:14px 22px;font-weight:600;display:inline-flex;gap:10px;text-decoration:none}
      .primary-btn{background:linear-gradient(135deg,var(--gold),var(--amber));color:#0A0B0D}
    </style>

    <meta name="theme-color" content="#0E0E0E" />

    <!-- JSON-LD base -->
    <script type="application/ld+json">{JSON.stringify(localBusinessLd)}</script>
    <script type="application/ld+json">{JSON.stringify(webSiteLd)}</script>
    {breadcrumbLd && <script type="application/ld+json">{JSON.stringify(breadcrumbLd)}</script>}

    <!-- Slot extra por pÃ¡gina -->
    <slot name="head" />

    <link rel="icon" href="/assets/logo-completo.png" />
  </head>

  <body class="min-h-screen antialiased">
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-amber-500 text-neutral-900 px-3 py-1 rounded"
    >
      Skip to content
    </a>

    <Header />
    <main id="main" class="min-h-[60vh]">
      <slot />
    </main>
    <Footer />

    <!-- Slot para JSON-LD especÃ­ficos -->
    <slot name="jsonld" />


    
  </body>
</html>
